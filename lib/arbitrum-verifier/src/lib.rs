use core::fmt::Debug;

use arbitrum_light_client_types::{ClientStateV1, Header};
use evm_storage_verifier::{verify_account_storage_root, verify_storage_proof};
use sha3::{Digest, Keccak256};
use unionlabs::{
    ethereum::slot::{MappingKey, Slot},
    primitives::{H256, U256},
};

#[derive(thiserror::Error, Debug, PartialEq, Clone)]
pub enum Error {
    #[error("invalid l1 contract address proof")]
    InvalidL1ContractAddressProof(#[source] evm_storage_verifier::error::Error),
    #[error("invalid _latestConfirmed proof")]
    InvalidNextNodeNumSlotProof(#[source] evm_storage_verifier::error::Error),
    #[error("invalid _nodes[_latestConfirmed].confirmData proof")]
    InvalidNodeConfirmDataProof(#[source] evm_storage_verifier::error::Error),
    #[error("invalid L2 proof")]
    InvalidL2Proof(#[source] evm_storage_verifier::error::Error),
}

pub fn verify_header_v1(
    client_state: &ClientStateV1,
    header: &Header,
    l1_state_root: H256,
) -> Result<(), Error> {
    // Verify that the L1 account root is part of the L1 root
    verify_account_storage_root(
        l1_state_root,
        &client_state.l1_contract_address,
        &header.l1_account_proof.proof,
        &header.l1_account_proof.storage_root,
    )
    .map_err(Error::InvalidL1ContractAddressProof)?;

    // Verify that the L1 `ClientState.l1_next_node_num_slot` is part of the L1 Rollup account root
    verify_storage_proof(
        header.l1_account_proof.storage_root,
        client_state.l1_next_node_num_slot,
        &rlp::encode(&header.l1_next_node_num_slot_proof.value),
        &header.l1_next_node_num_slot_proof.proof,
    )
    .map_err(Error::InvalidNextNodeNumSlotProof)?;

    let node_num = {
        let slot_offset_bytes = client_state.l1_next_node_num_slot_offset_bytes.inner() as usize;
        // the .value is verified by the proof above
        u64::from_be_bytes(
            header.l1_next_node_num_slot_proof.value.to_be_bytes()
                [slot_offset_bytes..slot_offset_bytes + 8]
                .try_into()
                .expect("size is correct; qed;"),
        )
    };

    // Verify that the L1 `_nodes[ClientState.l1_nodes_slot].confirmData` is part of the L1 Rollup account root
    let node_confirm_data_slot = nodes_confirm_data_mapping_key(
        client_state.l1_nodes_slot,
        node_num,
        client_state.l1_nodes_confirm_data_offset,
    );

    let expected_confirm_data = Keccak256::new()
        .chain_update(dbg!(header.l2_header.hash()))
        .chain_update(header.l2_header.extra_data)
        .finalize();

    // Verify that the node's `confirmData` is correct
    verify_storage_proof(
        header.l1_account_proof.storage_root,
        node_confirm_data_slot,
        &rlp::encode(&U256::from_be_bytes(expected_confirm_data.into())),
        &header.l1_nodes_slot_proof.proof,
    )
    .map_err(Error::InvalidNodeConfirmDataProof)?;

    // Verify that the ibc account root is part of the L2 root
    verify_account_storage_root(
        header.l2_header.state_root,
        &client_state.ibc_contract_address,
        &header.l2_ibc_account_proof.proof,
        &header.l2_ibc_account_proof.storage_root,
    )
    .map_err(Error::InvalidL2Proof)?;

    Ok(())
}

/// Storage slot of a `mapping(uint64 => Node)` mapping, where the mapping is at slot `slot` and the `uint64` is the `nodeNum`, accessing the storage at the offset of confirm_data_offset.
pub fn nodes_confirm_data_mapping_key(
    slot: U256,
    node_num: u64,
    confirm_data_offset: U256,
) -> U256 {
    Slot::Mapping(&Slot::Offset(slot), MappingKey::Uint64(node_num)).slot() + confirm_data_offset
}

#[cfg(test)]
mod tests {
    use arbitrum_light_client_types::{ClientState, ConsensusState};
    use hex_literal::hex;

    use super::*;

    #[test]
    fn verify_header_v1_works() {
        let header = serde_json::from_str::<Header>(
            r#"{"l1_height":"8050421","l2_header":{"miner":"0xa4b000000000000000000073657175656e636572","nonce":"0x000000000000002f","number":"170001","gas_used":40271,"mix_hash":"0x000000000000000200000000007a2a7200000000000000200000000000000000","gas_limit":1125899906842624,"timestamp":1743246347,"difficulty":"1","extra_data":"0x5fa375a6a86d04dc75595355d967f63e4518bd2766f2454237ee4dbbb11cffab","logs_bloom":"0x000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000400000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004800000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000040000000000000800000000000000000000000000000000000000000000000000000","state_root":"0x57050d60062f2e4265747be851fa11327143b88e8c11d82b05e9cf6fe8181b55","parent_hash":"0x372f5b0b6d84d0cdfb4b046d85f3f2c13397cb2257543308d7841b6015f1f034","sha3_uncles":"0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347","receipts_root":"0x76bc962f15e7cffe2a45fb21016f22469a23e1a7bd44e015412067dd84754533","base_fee_per_gas":"10000000","transactions_root":"0x9a8770ed8eab172d4fa41941d8aed2daa76b140b8391d69a7b343bd1a8b2e0c3"},"l1_account_proof":{"proof":["0xf90211a06a2fd546bde2e6d0c662c6db93010d69be3441ddc98e154c4098d805e567c302a087b5b742f9047571c9db80ac7b46145e06ef52887416552d2ecd17a2660c4613a051a1b906d2a878409390104973880aee85c5055fd349850e21a8d14725fc1548a06aac6a6a8030ac0e20d7e50ae095444dabb60b9ef980abbb5fa67a062a73e0c4a0b56b453ca4d4fd2237157e44644af516e325a72d96c125090c060e130ce87605a0eb71e21268b8b0ad25a54246670cafd8eaf33e0c3e0d0af230da7fdec9cb7e24a07820713689635d6cc3f530f9d40eb6b3e95e62a6884914022f510dc650142866a051869796bb83050cbf8084b87c50868b8fee147cb0b33e1300d45938593859bca006663435865e41433266415800d6f9a02163a1381ee8ce7a6a1889fb6201b84fa016d513ece36efd7d792144878b0f413ffc6b08808e693df59dc28b01023b64cba0106cd144c6e92d354867418817b6829e9fc66ce1bd81d9342b755ef8aabedf76a01310ee2bcdf54a876fe0cc15e3528725c0ca6982c9e91e5802c7e3d3ed090b83a0256a169499e135cc3bebb104a058511d67a95c513e43a0d01c90a3c64f5f7980a0f69e567ba0f081d73e05df616be420c3ee460847c50ea6540a4f4c6be139df15a0a77d96834267a61a30cf4c860c893a37eca132a3621b7302b89e6523c49c5f93a0d3d925fe3334a6a81d7bdf84024dc688ed39f97cb7ceced0f01f76132467236380","0xf90211a024172054bfd9872840b1f58cbc11136665d1c1964241db496735340e48e85638a0949ee1ab963a456aa08d7752511e4581267baaffaa5eb413113cb9c0fb905785a06af6fd31b94c4e6262c6adff19e2848844a1719aa91233579a69e8767ea7fc87a0cf3f2e9b1ef3b0df571d38dc07ba87520588600c9f34ec8b121515c734c5bcaaa09432c3a3030ff709dd9ce50fe7f631789e63d8f192c4b368f7010fe087a0ce8da0dc116d19d0711199eb5f1c9521ced99266e7cc8444583cf4cc2987a386ceefb2a0365827714a52bcc2d02c2efa9a206e932d5b1e56c6b01ba7132a340eee45bb49a0468d043cc32fa0986cce54479b625b1fe05698dc821e90b7b174a549b227b20fa09f158653c5cd5289cbe10cfabdbec3200c1e7a2b24a5ce8316ddcf24a268386da0a4a8aa0f8a5b866b700a09a7c2bd82a62ab3574ec094166c85e50ff2720770eca076402e3594503d0edade704fef78c24eed4e62cfd7326c3347b2feef34f88cbea0bb2164c02e2d92e70c17643d4e51258df38e64c13dfe939d7fa7e2ea926ed3b8a07b04ef47297aa1acbdd7d5e2571dea77bab1a49e78785e0f7d7d705666307be3a0d7c0b473d6fb1272627177b65fe449f69af12d39d8cf49c910671bf53abbce6fa0c7a39891abe88aa0b38a681c1f82c259b2d73ec9cd0d390baf37d6e3520896f9a0d648b6b169d293596b94bf6d17398370d31dd1faafc0d639ba1e7b03eb80b34680","0xf90211a0863f2e390bf33972b5f1d1aada652627b1a8be13b212a3eff9286a631ca4d2a4a01c873a37b24a12617290f41452a485dee704201ccf43d7da5a92336166d604f7a0582f7d206a09811c6ac994afe505feb7a9cd69faac4948303294ea88b505f71ea07658c37ccbe0a3937d79568666ca030536785f3f4e2c642ceca6d15d6cf1f495a0a7360e274f174718274143113eddf6317bb465ad088733cf685456e16f3658eca05861aab7df3676dd1f43fe5d9aa4cc4771b5cfd3e98cdc9b4fbb868e973fe1eda05941da5d7a056bd428a5fedaf8035c137c797a4cb32c1192d80e36b4ea69df04a083893baf6e5f63a02fad21ba4ad006bb2253112478061d327f6797137819a402a07907f6f12e17997bbedf5e05302396d10c76b54152458c90b6d626aa2fe3f25ca0a149c48acaa515e69cb0748488a3db8f6ab0e78e7e1e43514574547610b3f82fa028ab5c4a40f1b4430a3a20266919cd9faf3f59f78edeb90991c35e62c834da24a07db693c31c47ec76af3a9ad23a17e6f7539cb5c0e403dcb61d67e5d7ef537e15a09a11c925d84f16f67b063ab5c92c87d5c60c92ce0e0655d2e2f7736ae5fe80c7a0a258b8e2d5032445505446f804b7ea74b0a33d5a622530d308f277a0062a9ee8a069818ccfe84a20f299c6d9f7afed8902a23dfc9c6fe85bd55f5a56c91c29e018a057f3316567ab6e28b0429d6aa0d6422e642b2440035e5a47490925d4ffe8a22a80","0xf90211a0be287334f891538d9c0cd423de15b35e8d91e67f997cd6fa90beeec79b18a6eca00c4cd9b809e49b47b00e71e8c1091f179260487d120d6b2243798d2e9cde95bca05818d38f8e218b5acd5467950d8c394bcfe9fabdc23ed849013d7b6a138152d4a0a760c8c16f86fe8fdb584073a599d3b5a55cb3eafac22a10ad4039beee790b01a0963d2cfa0c4bfc78bb70cba3e66fa26611fa075386009ef59abfa2babad5e76ca0a379f2adb70ccdf4b78565a38ffa02e434cbd4701bc089a7bef9453159f080c8a021da599ff0b6098fbe75c2a448795512dbbdb4faf63de5660f4d4ce166312394a0b8c21e0e8fc5c7a7839656a3dfacba31ec6227f22375e06c94808dd717187d94a0a0700a6a72cdc3c7b11c65063fd809b659c5487f750a46696cb95ee45c9da226a092f33b1f6daa568524704419faf0cc476096a37ac4b3e0b278b0f6175988c31fa07aff7e1255ba555664c431c7e69f34e9939ff2afb8830e8a033dce8394669ab7a0c37bf974eee286655242080c64f2217c2bb902e2743c55eb9b0e959ece438e6aa01ad0a24b4e280bb361a95bfda3d5514a7d8317527b5d85f0553591e23f46a953a0772e5cb725d0fb5d35bd358d43b8efde96833af31261349a43a4bbd09a24562ea091d75c77286e5b863c8232a0faadfcbb14c9753fba65a56c2da0e348e73935c2a0959aed9e30ddf73859fe1317d4f9ab4f6fb11776a971693974b3f1c3f62b167c80","0xf90211a0978cc80d285df07c64f6600be4562ac03ec28db895740506bad69f69ca673e07a063b0d1328f834dc6fe28026d5986669c0289767eea5948609d0eae7e311c938ba007f03e3b67c6a3a64b84107c0c231c07cac255ae8079018dae8013fa86e5f3bca066d436c7a908f816534302c7cba60780b81d55e454a3660a845695f8fe708d47a01a7263a224e8a01e77b8d6662a4ca63503b94d3098f85f9c4ce6f34c3f861a6aa0671c2eb9a405d161a16bf3e4c55f2efb0493ade9cf4bf8b740d0c0fa4b263396a000d9c46b54c8f3a5c59774599b8299047905e0d7255e2e783a006bdd05709b7ea0932a80bf5522586ac1ee96f980d6f844927e8833ad0e9f1658d0637d920d993ca0b74a9be81b6070a57a58cc1119066420d80094624f16716940081129ac846959a04c77fede2e801f2958798810133beae6e7ea481d3d537a9cc42950d83f81c018a0d96c7b02f783614bf755d4db1054eeb00b1a9a64de4c7f1e0d7e66ac7ee05b52a00ee1f38d34053f99ad5e4df7fd29e3cf8dd9dbd3d2bee027672d7e0622cab466a0157013cdc8366e2c42e39d2e4c17938faf983c0e1ef5377939135c43435ac874a02b937fd3ad8dffe190782d237bf859cb0584b61fa88aa49563210b18132267f2a0de232f38937169c9789c7fe8bc48e208f8ab728594baf528263707138ce8e718a011e97b7a434e0edae6a8a77d3472f36025c1798ca5afdc0c88e586a0480bda7a80","0xf90211a04711c5b2e10040f3844fa332b369fc515ec8321ec8c706fbdcfdd8a1a7903276a0de0e82cbab661d44f4306eb7870b3bb02da902921d6298b9162e5fab8a1729ada08952e0684f9526724d2eb2a10da9b20856ea919345f68791c70ed7a0c201f1d8a0c722ed649bef6ae586c67c5927f23fae1dd79694cd1999376b3935fc86188a63a0ee5ed59ea90658958c94adeed7922e5c640378151a18ba63ee7472565616b047a0157feb8fd0382e5709afb2d3cc09ec1f530b73224234e94f9c088443c704b675a0be321a42abb683ebc95df94c757800a25d3ea22a13ac18b9350e2a990b48be55a09af04797972640735d9cd95c73b5f647d518a286ceb6acd734747a079f37a66ba0bd5fdebfe176701ff0616114f6250eb682adb4ed8fbd8f1f7b0c643daa231401a01643eb0cfbc20f03556341f963412938f2f8fbdfaabe15d37eac256d317b9b18a0f26efb33476a49730b42cb9dd717556379710189d77d6174f60728c7c8d58ad8a05582e0c27a56ff1c98aadc2a33ac41e9ecd4953e87ebd16861ae0e3817cfb990a0f350a004b79f81d237ca9eb7aa794f36193d78f73720cb381a69c991c0445138a019c0e8c507b7acd7e287f3a8e5c2532836ce05a60040881b9c38de08589f8070a01a11e897fe1afa6308c7e652691edc0ea4d437d70aa3bf15fc2da265b81fbf59a00a548a538011c659d3ef87ae5e853837c5c4f89f814462f2963d6aee195c155880","0xf8d180a042925ca70459c9565b5aaeb43d72ca0f9604e2a2bdb35fedaa4a7bafe6d4773b80a03856a7557eae2e5dc64b0e0df937da9ae2091dbf9e7b3088a4de55da3e5b1d838080a0b094f9ba65db0d58db682564e1ae3f25ff484d008d47e971972db6e7344e300780a0e98145072bd10af47d7ee3ffd4fa57902899d417b461d9dd7c3e4ecf39b78833a06d4331d28c8ce60111ec265e1511273f40ece94739dad37bc66f39c385da183280808080a0fd4f390f5c1441111c971caef38057496edf82d16da9cddeeb293e63e46015c58080","0xf86e9d3d290908223223d510abe09bba785117a71bce51796ea9a88be577643eb84ef84c0188016345785d8a0000a0ef8f74f4f3f9f3120eaddefb71e20c7938e9d564512337ee0b71c5b4f5452c0da0f8cb3ff11d3c43193ca30b0cc6c21d1143f072e4b45bd4c2af1069c9fa69ca10"],"storage_root":"0xef8f74f4f3f9f3120eaddefb71e20c7938e9d564512337ee0b71c5b4f5452c0d"},"l1_nodes_slot_proof":{"key":"109193836305716069669136506675814656487401730155758621378768392037613268239022","proof":["0xf90211a0abcf1fe607446de49161c2447ecee768cda4d38c70aeae2a7e7234a1cb2b0542a0a5032a774215fa32a5b74773966e2735c39af510c6fe606ae093cf9277bf8761a0b784abc4936bcb27d8355b8311ae7644ba506a59c2f7061b7d52fc4c434c0517a07447608e14c57901866ffd97d5418e8bca5593b66dc2b2ca0743a62bf5b8efc4a09e9573ff46d2119f76a8ecba35970260de807b7ca1990d4805224bf8b058d175a078821092621d2e3f7f621e8d15c9da570f234fe0e644ff296a08c1884b312f9ea0869ab24ec3c1908b0957f6d4996fcbc4cd72550000e4db1d882b6d73226099a2a0c52e5f5233cd5fe62d3818dd0e64c28807389e2a3b1bbfab023c2c9255ed19bda07aa3a62d9b79012356988c11ef530ce647af37be7ddfb0671e3f502a3439d346a0de82c14342dc8cee286c84b921eed2084a81031b4fca2b4c78001003673a9828a0a2efa905925beee396d402f5602e308cff5ea7130db23f683b37d6d50e616731a040d0f37dff843b1660c606e8f03b1201a25ed7b0fbd3098c9a1eea576fc21ae4a087922516d5a213262c42af3c84caf92f9acd9d65e442e318c4e8fb2e1566cc86a05389d84370d32761c9412051f24b5478d3402f1d419c3ae821908ed097cc24a0a02663c4dc28c1d06aa1a3857b047129f7b19d1d4ca0c26cd27c87175adbef9c56a017f94590b4244ded96f036bdbb8e0922301bf3b3bfb561d4bff8cd5410e824cb80","0xf90211a0863679ec0454588a0733adad6a0af8ae177a3ba56f0d0d2cfcb294b1a2efa62da096d1ccb485e8a6538cbff3f8e989c8b57daa43ba54d4717383d24b4bf45552d4a0f7a35bdf2753ea50dddfb2ee811873d29b8e83613d2df2cd4aa5fc7f501b35e0a02a98308b63afcbee1a779a2aae53cb9f5dab46f5b24baafffae54f975418350aa07b87d8de54b8b0b6945cffd1c1be53c7d530fdc2f499d6d0515b8db9a5315bc0a0cc7dabb34be65524d10e25bb09b3c47a9f457bc7678ca51c767608b21ca6dbaaa0beca59427f4bc6acb8204bfa607cf74c85093c4bf591623e3fef98ca134864f1a0490cfcafe41cb2be9bfc2053845282d0fb90517f04114b897d65939a283f2c5ca049307378d751d01eac8cac81bb2c315fa7027bb22cc545c7afca11fa4f1de42ea0898a5881ed64c0bd79dc31dccd65f58f5515ef87d675d7753f5674079c29167ea04e6e21f6ea49fa5bfb5107a748eaa30d41ef4034c96584fa51c6dc53b763a2d9a0d4c28dc349315edf18e4dfe22c7564f44c9707bf7914122943f98ee6cfa6bce9a0763161a3fff1845f06160938b69831f55c50582c66d1d4a4be79272427f439aca03762f50260303bce37c27cb02908165dc8c97ebd9861ba30458093604b00ec63a0691cb19e6e8b2d57bcf2844c463e2dc5306dbc05fc75b5e394e236e161fa8272a03faf00222a1eb436ee5bcbc030fabaf916b93b5bf9b65612c61d1b31b38360a780","0xf901f1a0b6104f4fbc7362003087587e3a90d314a9717f36a818a5de23fe812cc0dd2a41a014b6c79509aeb52221f82518808f758e73f04b75ad733fb964012bcdebd8510f80a0fb9beb6a08ca2c84f6d36ea0a20593b45ed946829df24dab6c67414896521dc6a0a3d9561c9619f047d45cd7ecf138d7259d5f22def38cd93bf37252e5589c281ea0c37ffe2d5ddb1614695538c6c4f467af7fd8bb9d2be225be5189615575d2e215a0b083a913747a3e3b7494785bd0722818e259dde80d6e8e1f050e276a8331e93ca0f15067edf6c6e541b0dfecd4887870f7b593ed403c44663324266f7e2cbac031a0a89d55b401affd9f4b062fb7e30015e467ac6c95b7d21d19d5f80c9195e3e56da0865dd81dcddcc8bfd618a45fb68551558cfcc8f59ca30a5eabfdb0fd9ea515a9a0b4c2253cbc10a4b5cc32768d799ac0e110586af61a41320dd131d49d019e8ad3a0b00171f9fff0a50f9063b467050a1c14aa514ae1fb97616168453cc879a2889fa0c165a51d6bc0d0ebb611539e4131d595b92ac9b1a1f34c605c6e41cf092979d4a0dfdd9fb4ab7382a3ef544ac1f76a138fcf9c653d6119990259cf772811f431c3a05c5fdeb50ff8002a2d405ff1cfc774656361a3fb993f1e46515ce00c89674634a02ae2ed6e464a8173941087ad764770f33117db8e5c85d99b9836a18eb34eeff880","0xf8718080808080a0915abe3161d1e1371ab318c4eedfaf4f618ce6ee8c54f753df67f829392fdf9780808080a0c73c52a6eb209cd1c5609030482b443dc2533e93b5c84344dd404a6f93f5859fa052a667180f96aaad400ea2321b7e719684eb99e1f1eed35dd7e7481da41a25df8080808080","0xf851a091d191e849c4f0ad650b343d259aca49de72fb1f474d8a7b781c3deec97a5c3a8080808080808080a0330c4db0e81a1fe9a2de09c6b83b9cf540f959fbcc74299fe2591bf1220d15bc80808080808080","0xf8419e3ffee6e93e0e3009cc45cb3b14cc09ed57ba8259d9f9a7b13e5d30fdd6a6a1a09bde3e863bace35f5756785b1cb950aa0ce71f93c6df7e3f09f31d0d53aa2afd"],"value":"70501163105977993209985203829312869004929434253555778321068357723347313371901"},"l2_ibc_account_proof":{"proof":["0xf90211a050d32fe881e7a42df67582a3ff6e2285f2bc4f24704007e3b1830d59f8341988a01ea4fdebcbea7144fbcb78d1737d0ad06bcac4914602c004e9aa15784a7ed8a3a0b13dc4a73d8408be519f02555009da51931b7bc88b81a5acf9f02f0b8e52c47ba08ddfdff3217f770d156e28a25ffc00083c2de2dd195f862600efa37c89656ee3a066f287c1251542ef03fb7f5d20b74f18f2dca02fb5919ee42c21220195e60dbda0c00db95ce21bcccb4f3ed66a0900c5e1b4b0c80b78287b615375e22560b7bd89a08c9ebb221c7f5748c92ab00724943835f84fec9891ac295c91730ce6294e0345a0a604bd832a70591b92f0e6c366dfe7af729e9226944bdef79017b42353c239a7a00af1fbd8ce2e9a8edfa519cbc638941e1a46190fb9f1d57890026b655f3a4996a08a33d89828a8881594c235d6b12c81f9e4cc204b6a58d9596d769efab585dcb3a087ed889ca1457ec57b536dc230239827c370354380c1bf289bfbb4ef4379a76aa07a9b90b05fa72ba8d265fa54599957853846f9181e07ce94b72fe4eaa0664106a00a9735375da66cf487a113edd62a09afb08d6a3ee377be087d76553e713b6c3ba0bbf110f360fc2462191248921df9e94a22843611fcb4fc670072b5c682f14c78a0e842aa730c49f67334aefd2fc56268c2ed8b886e92faf491b357e4c2fc1251aba05bef068d150f864998c63fad141ff97cb5bf283abe9da666cb319221ea44556280","0xf90211a0f4a70e0b9825050faca828d18fedf2a81ea738b5e85d4e92f8d8f14f3cb250b5a0d3662772d609c020554f6c5c8e3c8d9a39e0828d6c955ab92efe1de688041153a06a02bfade7f278687bfa1d1c3524d951e62f7327ba3be48dc892e043d364f729a02a41c79bc9be3697a7d825d9a03742344ddf76f7e8fe3342d28133cbe4bd41eda04ca59c3b982051523cba415dacd9fe47e8a863c8facd929d0f689d4a2c1be7aea0b192c0ab431d352c05b41579a875c2818e0f7d86a6246df3ea64b19ad0eeb2aca0f4e973e9e12f651814a13f6f04d46e7fc5dd01ee8c38f680416624b47928fb57a05effa43cd9fc19e6f20db0be8f31853c03eed9f0a0ab2497d58c65adc0a4c241a0582696919362619cb56f97dcea5e657bbd20d735b23cb862de94af09c73de4e2a07e1f86c6c04226886933ad7c44da1d04e7929697ee694ab3ef7dc84f7235a894a0a5629693ff0a368cfd8884bfa3d81d5737e3293a2acda86c5c101f8c758b5c63a0e2de8a7be5e07307db495dbddea5dd5fb16f4689a0fe2bcecbdb7b66740917aca0e0e004c224f1ecb3d5719cdc0824a33ceda8875d1d5bc5a0b732466546bd0f44a084e9b0d74146a07de7b64ba874f73b58b6f34112a280404fc5ca33fd09ff3c6aa0c03bbee301abcb3403b68bdeecb199936f1bb0bb557e0a05bdee1d85a4435877a0a173ecbe7f2275bcc4a98736a4267a0f7831a80f7247ac7e4024c637b059ae6280","0xf8d1a09d0b8f26e5709b0199c227afbd74a3f961d9c3e1b8de9128b060d6f87f36b92080808080a08a5c74905b21551ab81ff4ab60ffccbc77c3f63ca27a7ad89554fcedc6fb7f1d808080a01d389fcfd29047e74d1722e9ecf9a7d799376af387da16cf827a44881dddff11a020a76e5989b853053cea316c04e9454d42762a8cd99be791f7795543f3ba195aa0f0b99eac794a704349b6f6b9f5b554a4fee73ed0fc379cd84af6e2b2ff17cc5da087ae7ac62174d46489c903cbbe1914fcf076e7c92d45ab33f438023b98e1756880808080","0xf8689f3411163a2f29c7a6becfdb946a45129ed5cbb7be9ff8e64ce7aed2ce32af20b846f8440180a09c7bc6a5df660ec70076e9be4cf86530e3b9e734166fcf0517242fa5a0bed688a0795c57e26220fed91dd5e491403ac8c689238eeb3ac1f841e1d9cc3222df5f9b"],"storage_root":"0x9c7bc6a5df660ec70076e9be4cf86530e3b9e734166fcf0517242fa5a0bed688"},"l1_next_node_num_slot_proof":{"key":"117","proof":["0xf90211a0abcf1fe607446de49161c2447ecee768cda4d38c70aeae2a7e7234a1cb2b0542a0a5032a774215fa32a5b74773966e2735c39af510c6fe606ae093cf9277bf8761a0b784abc4936bcb27d8355b8311ae7644ba506a59c2f7061b7d52fc4c434c0517a07447608e14c57901866ffd97d5418e8bca5593b66dc2b2ca0743a62bf5b8efc4a09e9573ff46d2119f76a8ecba35970260de807b7ca1990d4805224bf8b058d175a078821092621d2e3f7f621e8d15c9da570f234fe0e644ff296a08c1884b312f9ea0869ab24ec3c1908b0957f6d4996fcbc4cd72550000e4db1d882b6d73226099a2a0c52e5f5233cd5fe62d3818dd0e64c28807389e2a3b1bbfab023c2c9255ed19bda07aa3a62d9b79012356988c11ef530ce647af37be7ddfb0671e3f502a3439d346a0de82c14342dc8cee286c84b921eed2084a81031b4fca2b4c78001003673a9828a0a2efa905925beee396d402f5602e308cff5ea7130db23f683b37d6d50e616731a040d0f37dff843b1660c606e8f03b1201a25ed7b0fbd3098c9a1eea576fc21ae4a087922516d5a213262c42af3c84caf92f9acd9d65e442e318c4e8fb2e1566cc86a05389d84370d32761c9412051f24b5478d3402f1d419c3ae821908ed097cc24a0a02663c4dc28c1d06aa1a3857b047129f7b19d1d4ca0c26cd27c87175adbef9c56a017f94590b4244ded96f036bdbb8e0922301bf3b3bfb561d4bff8cd5410e824cb80","0xf90211a0893ab29a493fb3ae9c72faa04431fe2a0d54df7b9289f3a2daf89e0b963a54f3a07a7d2d1847a8bf7c72731339bb0db95a99a6df630029eb1183d8906a1f760404a0df68e1ac3e12be190a1daae7ee09a3a84bc50feb1fdccb8bda527d79028301a7a0def5df6fbb25876484e5524c01b60d437e5b42451144d958453e0e167ed5b8a6a0ff9ac185786d6b40be5a3c7c897bb7eeaea840a3c02cc64e72b88651fa9eb917a040abaf7745dfc085faab43e8f64b5c0c84514ae44f7ed1a20ffc7788790cec4fa0eaa9e2f6051c5e1e4b50fa2345fc194543c387eaded215a120bfdeabb46c4560a00bd7d9ab90cf564451fe4b14a8d05e9a9e333d935298766a35733796622a9d61a0d0b2a668eee1f239a5a899ca8beebfa025e0dc30a216f2e33400ed695087a38ca042eaae8cf8e48b512e75cf0da31c5e182b50b99857464df474083e3409e1bdcaa010350fb521c22721fd65280fbda70f2346c5f851f116a4b100138af17a3e78d6a04fcb74279d010acd29758524b5ca4171941843f4eefbdf7344626da7a85cb319a046657bb1d5fa61887bf4f5821106159c0bd4d5750cd57a4cb26fa1ee9851d5d3a0ceadb8b02842afd587a0c25a9eb5bd5e70e6b534363b22876ebdf9ce5d6e1294a04614e2bcbe7f3e81a1555fd467743bfa6b56490fc044e51988cdfcd5e5e48c26a04248138030e658d995e03f8e761bf0b9c4f696802cf10ab4cf748603acfa3c5c80","0xf90211a08480ca3f5828a50e914c3f5650ed135119770dd96608b180e6c01e1da5edda7da0ba9c688ed9993281213cedf64c40e9c5b44f84ec3a8efe4fc11805bf72b4b48ca03b301a0f54e524a0bde516ed59d2a7791632241deb932510b451c80e0a530bb1a0c4ba868a4e4e77419f7736bb6fa3bb08882bbea542a1355027e15046208febd4a09cc42a47ed2098b0d3c3d60d55a96929fa3a45d87ce7db2c6256da885883094ea044cb87e48720052c39e571ba49c215218e992a055367995e697bcc8cd198357ca0a3335f957a729c784c1c3e0d0441de297e1646e8327130f6b8f4faebda8d6661a07a1a15c9042a77c60343260527abb0b505dd22a75a297aaf4592a5c9212dd9b5a07cd13874397b01850223c40cb9de0ba42c7a1cbd960be322fa545e7d59be9acea0afa1a682914c10ff3bd3e2be1bdbbe7abd1101b4c578f6cea17d11082ab47d96a040f7f4746637c037c11951950fbe78c9a5940d5d7c3fdb8a9e763098406c8306a0f8611d790b4dba7fae14fdee5dfd4b796341ffcf45e19ec0b954a231951338eca097acef1716dbac0cc06a114228acb06a34c564bf68b3d64bed408a57d1a512f4a0c7bcdd8021cb5e20abad7756478a2d4165ab8d848896e12ba65fefd8cb57289ca053ef83a57d7075888aa3bc2243e0e98d300c7eb79c912f003c87e9148ac99832a03ef7bf22576fa01b5a235342aeed4af839db4d4b398ef348700ba1a23ad8083e80","0xf8918080808080808080a031421d0233b71852aeeda8801c6ee14507d15ad6834edaad66d22bc328e6f96e8080a0e324715d1594b0a612614d95023ecc35f5eeb103ee858ffe6a58821ee6b2a243a0c335c3fa1dfd41ab91d6a3b40cd8bde670b81b277c456e2314507c495cda0faba0f985da39757edfefa298528106012cbf5635309c3d5b5725ed85cd36683be335808080","0xf83d9f2093986a7b9e6294572ea6736696119c195c1a9f5eae642d3c5fcd44e49dea9c9b6b64d90000000000000c0e0000000000000c0f0000000000000c0e"],"value":"44179302843844739564926424320332396348251003835345479301681122318"}}"#).unwrap();

        let ClientState::V1(client_state) = serde_json::from_str::<ClientState>(r#"{"v1":{"chain_id":"21000001","latest_height":170000,"l1_client_id":8,"l1_contract_address":"0xd318638594a5b17b50a1389b0c0580576226c0ae","l1_next_node_num_slot":"117","l1_nodes_slot":"118","l1_next_node_num_slot_offset_bytes":24,"l1_nodes_confirm_data_offset":"2","frozen_height":"0","ibc_contract_address":"0x06a409cbed33caa9bf8181ef3aff2c504e1cfb95"}}"#).unwrap();

        let consensus_state = serde_json::from_str::<ConsensusState>(r#"{"ibc_storage_root":"0x9c7bc6a5df660ec70076e9be4cf86530e3b9e734166fcf0517242fa5a0bed688","timestamp":1743246085000000000}"#).unwrap();

        let cd = Keccak256::new()
            .chain_update(header.l2_header.hash())
            .chain_update(header.l2_header.extra_data)
            .finalize();

        dbg!(<H256>::from(cd));

        verify_header_v1(
            &client_state,
            &header,
            hex!("c48b86aaf71de8faf41c432d38e0b4b95ca229722087824e33d94fd7002dd9b2").into(),
        )
        .unwrap();
    }
}
